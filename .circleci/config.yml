version: 2
references:
  default_env: &default_env
    docker:
      - image: circleci/node:8.10.0
    working_directory: ~/repo

  repo_cache_key_1: &repo_cache_key_1 v2-repo-{{ .Branch }}-{{ .Revision }}
  repo_cache_key_2: &repo_cache_key_2 v2-repo-{{ .Branch }}
  repo_cache_key_3: &repo_cache_key_3 v2-repo-

  restore_repo: &restore_repo
    restore_cache:
      keys:
        - *repo_cache_key_1
        - *repo_cache_key_2
        - *repo_cache_key_3

  set_git_user: &set_git_user
    run:
      name: Set git user
      command: |
        git config --global user.email "dev@codecademy.com"
        git config --global user.name "circleci"
        git config --global push.default current

  set_npm_token: &set_npm_token
    run:
      name: Add NPM auth token file
      command: echo "//registry.npmjs.org/:_authToken=\${NPM_TOKEN}" > .npmrc

jobs:
  checkout_code:
    <<: *default_env
    steps:
      - *restore_repo
      - checkout
      - *set_npm_token
      - run: yarn --production=false
      - save_cache:
          key: *repo_cache_key_1
          paths:
            - .

  verify_formatting:
    <<: *default_env
    steps:
      - *restore_repo
      - run:
          name: Verify Prettier
          command: yarn format:verify

  verify_linting:
    <<: *default_env
    steps:
      - *restore_repo
      - run:
          name: Verify ESLint
          command: yarn lint --format junit --output-file /tmp/test-results/eslint.xml
      - store_test_results:
          path: /tmp/test-results

  tests:
    <<: *default_env
    steps:
      - *restore_repo
      - run:
          name: Run test suite
          command: yarn test

  publish:
    <<: *default_env
    steps:
      - *set_git_user
      - *restore_repo
      - checkout
      - *set_npm_token
      - run:
          name: build packages
          command: yarn build-all
      - run:
          name: Add changes to git
          command: git add -A
      - run:
          name: lerna publish
          command: yarn lerna publish --conventional-commits --yes

  publish_alpha:
    <<: *default_env
    steps:
      - *set_git_user
      - *restore_repo
      - checkout
      - *set_npm_token
      - run:
          name: lerna publish
          command: yarn lerna publish --yes --skip-git --exact --npm-tag=prerelease --cd-version=prerelease --preid=alpha.${CIRCLE_SHA1:0:6}

workflows:
  version: 2
  build-test:
    jobs:
      - checkout_code:
          context: org-global
      - tests:
          requires:
            - checkout_code
      - verify_linting:
          requires:
            - checkout_code
      - verify_formatting:
          requires:
            - checkout_code
      - publish:
          context: org-global
          requires:
            - checkout_code
          filters:
            branches:
              only: master
      - publish_alpha:
          context: org-global
          filters:
            branches:
              ignore: master
          requires:
            - tests
            - checkout_code
