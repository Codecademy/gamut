version: 2

references:
  default_env: &default_env
    docker:
      - image: circleci/node:8.10.0
    working_directory: ~/repo

  repo_cache_key_1: &repo_cache_key_1
    v2-repo-{{ .Branch }}-{{ .Revision }}
  repo_cache_key_2: &repo_cache_key_2
    v2-repo-{{ .Branch }}
  repo_cache_key_3: &repo_cache_key_3
    v2-repo-

  restore_repo: &restore_repo
    restore_cache:
      keys:
        - *repo_cache_key_1
        - *repo_cache_key_2
        - *repo_cache_key_3

  set_git_user: &set_git_user
    run:
      name: Set git user
      command: |
        git config --global user.email "dev@codecademy.com"
        git config --global user.name "circleci"
        git config --global push.default current

  set_npm_token: &set_npm_token
    run:
      name: Add NPM auth token file
      command: echo "//registry.npmjs.org/:_authToken=\${NPM_TOKEN}" > .npmrc

  yarn_cache_key_1: &yarn_cache_key_1
    v3-node_dependencies-{{ checksum "yarn.lock" }}
  yarn_cache_key_2: &yarn_cache_key_2
    v3-node_dependencies-

  restore_yarn_dependencies: &restore_yarn_dependencies
    restore_cache:
      keys:
        - *yarn_cache_key_1
        - *yarn_cache_key_2

jobs:
  checkout_code:
    <<: *default_env
    steps:
      - *restore_repo
      - checkout
      - *set_npm_token
      - save_cache:
          key: *repo_cache_key_1
          paths:
            - .

  install_yarn_dependencies:
    <<: *default_env
    steps:
      - *restore_repo
      - *set_npm_token
      - *restore_yarn_dependencies
      - run: yarn --production=false
      - save_cache:
          key: *yarn_cache_key_1
          paths:
            - node_modules
            - .yarncache

  tests:
    <<: *default_env
    steps:
      - *restore_repo
      - *restore_yarn_dependencies
      - run:
          name: Run test suite
          command: yarn test

  publish:
    <<: *default_env
    steps:
      - *set_git_user
      - *restore_repo
      - checkout
      - *set_npm_token
      - *restore_yarn_dependencies
      - run: yarn --production=false
      - run:
          name: build packages
          command: yarn build-all
      - run:
          name: Add changes to git
          command: git add -A
      - run:
          name: lerna publish
          command: yarn lerna publish --conventional-commits --yes

  publish_alpha:
    <<: *default_env
    steps:
      - *set_git_user
      - *restore_repo
      - checkout
      - *set_npm_token
      - *restore_yarn_dependencies
      - run: yarn --production=false
      - run:
          name: lerna publish
          command: yarn lerna publish --yes --skip-git --exact --npm-tag=prerelease --cd-version=prerelease --preid=alpha.${CIRCLE_SHA1:0:6}

workflows:
  version: 2
  build-test:
    jobs:
      - checkout_code:
          context: org-global
      - install_yarn_dependencies:
          context: org-global
          requires:
            - checkout_code
      - tests:
          requires:
            - install_yarn_dependencies
      - publish:
          context: org-global
          requires:
            - install_yarn_dependencies
          filters:
            branches:
              only: master
      - publish_alpha:
          context: org-global
          filters:
            branches:
              ignore: master
          requires:
            - tests
            - install_yarn_dependencies
