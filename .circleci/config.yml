version: 2
references:
  default_env: &default_env
    docker:
      - image: circleci/node:8.10.0
    working_directory: ~/repo
    environment:
      GITHUB_BOT_USERNAME: codecademydev
      NODE_OPTIONS: "--max_old_space_size=4096"

  repo_cache_key_1: &repo_cache_key_1 v3-repo-{{ .Branch }}-{{ .Revision }}
  repo_cache_key_2: &repo_cache_key_2 v3-repo-{{ .Branch }}
  repo_cache_key_3: &repo_cache_key_3 v3-repo-

  restore_repo: &restore_repo
    restore_cache:
      keys:
        - *repo_cache_key_1
        - *repo_cache_key_2
        - *repo_cache_key_3

  set_git_user: &set_git_user
    run:
      name: Set git user
      command: |
        git config --global user.email "dev@codecademy.com"
        git config --global user.name "codecademydev"
        git config --global push.default current

  set_npm_token: &set_npm_token
    run:
      name: Add NPM auth token file
      command: echo "//registry.npmjs.org/:_authToken=\${NPM_TOKEN}" > .npmrc

  skip_on_automated_commit: &skip_on_automated_commit
    run:
      name: Skip build from automated commit
      command: |
        echo "Build started due to commit by ${CIRCLE_USERNAME}, blocking builds started by ${GITHUB_BOT_USERNAME}"
        if [ $CIRCLE_USERNAME == $GITHUB_BOT_USERNAME ] ; then circleci step halt ; fi

  add_github_ssh_key: &add_github_ssh_key
    add_ssh_keys:
      fingerprints:
        - "a5:44:32:aa:f4:81:ad:6e:6b:cf:32:77:f0:a9:4f:93"

jobs:
  checkout_code:
    <<: *default_env
    steps:
      - *restore_repo
      - checkout
      - *set_npm_token
      - run: npx yarn@1.15.2 --production=false --frozen-lockfile
      - save_cache:
          key: *repo_cache_key_1
          paths:
            - .

  verify_formatting:
    <<: *default_env
    steps:
      - *restore_repo
      - run:
          name: Verify Prettier
          command: yarn format:verify

  verify_linting:
    <<: *default_env
    steps:
      - *restore_repo
      - run:
          name: Verify ESLint
          command: yarn lint --format junit --output-file /tmp/test-results/eslint.xml
      - store_test_results:
          path: /tmp/test-results

  verify_packages:
    <<: *default_env
    steps:
      - *restore_repo
      - run:
          name: Verify Packages
          command: yarn verify-all

  tests:
    <<: *default_env
    parallelism: 4
    steps:
      - *restore_repo
      - run:
          name: Run any builds needed for tests
          command: yarn build-all
      - run:
          name: Run test suite
          command: |
            TESTFILES=$(circleci tests glob "**/*-test.{jsx,tsx,js,ts}" | circleci tests split)
            yarn test ${TESTFILES}

  publish:
    <<: *default_env
    steps:
      - *skip_on_automated_commit
      - *add_github_ssh_key
      - *set_git_user
      - *restore_repo
      - checkout
      - *set_npm_token
      - run:
          name: lerna version
          command: yarn lerna version --include-merged-tags --conventional-commits --yes --create-release=github
      - run:
          name: lerna publish
          command: yarn lerna publish from-git --yes
      - run:
          # Storybook build will fail if there were no changed packages, but we still want to build
          name: build packages
          command: yarn build-all
      - run:
          name: build storybook
          command: yarn build-storybook
      - run:
          name: commit storybook changes
          command: |
            if [ -n "$(git status --porcelain)" ]; then
              git add -A
              git commit -am "chore: build storybook"
              git push
            fi
      - run:
          name: update lockfile
          command: |
            npx yarn@1.15.2 --production=false
            if [ -n "$(git status --porcelain)" ]; then
              git add -A
              git commit -am "chore: updated yarn.lock"
              git push
            fi

  publish_alpha:
    <<: *default_env
    steps:
      - *skip_on_automated_commit
      - *add_github_ssh_key
      - *set_git_user
      - *restore_repo
      - checkout
      - *set_npm_token
      - run:
          name: lerna version (alpha)
          command: yarn lerna version prerelease --include-merged-tags --conventional-commits --yes --no-push --preid=alpha.${CIRCLE_SHA1:0:6}
      - run:
          name: lerna publish (alpha)
          command: yarn lerna publish from-git --canary --yes --no-git-reset --preid=prerelease --dist-tag=prerelease

workflows:
  version: 2
  build-test:
    jobs:
      - checkout_code:
          context: org-global
      - tests:
          requires:
            - checkout_code
      - verify_linting:
          requires:
            - checkout_code
      - verify_formatting:
          requires:
            - checkout_code
      - verify_packages:
          requires:
            - checkout_code
      - publish:
          context: org-global
          requires:
            - checkout_code
          filters:
            branches:
              only: master
      - publish_alpha:
          context: org-global
          filters:
            branches:
              ignore: master
          requires:
            - checkout_code
