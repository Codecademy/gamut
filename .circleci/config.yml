version: 2

references:
  default_env: &default_env
    docker:
      - image: circleci/node:6.12.2
    working_directory: ~/repo

  restore_repo: &restore_repo
    restore_cache:
      keys:
        - v1-repo-{{ .Branch }}-{{ .Revision }}
        - v1-repo-{{ .Branch }}
        - v1-repo

  set_npm_token: &set_npm_token
    run:
      name: Add NPM auth token file
      command: echo "//registry.npmjs.org/:_authToken=\${NPM_TOKEN}" > .npmrc

  yarn_cache_key_1: &yarn_cache_key_1
    v2-node_dependencies-{ checksum "yarn.lock" }
  yarn_cache_key_2: &yarn_cache_key_2
    v2-node_dependencies-

  resore_yarn_dependencies: &resore_yarn_dependencies
    restore_cache:
      keys:
        - *yarn_cache_key_1
        - *yarn_cache_key_2

jobs:
  checkout_code:
    <<: *default_env
    steps:
      - *restore_repo
      - *set_npm_token
      - checkout
      - save_cache:
          key: v1-repo-{{ .Branch }}-{{ .Revision }}
          paths:
            - .

  install_yarn_dependencies:
    <<: *default_env
    steps:
      - *restore_repo
      - *resore_yarn_dependencies
      - run: sudo npm install yarn@1.3.2 -g
      - run: yarn --production=false --cache-folder .yarncache
      - save_cache:
          key: *yarn_cache_key_1
          paths:
            - node_modules
            - .yarncache
            - packages/*/node_modules
            - packages/**/node_modules

  run_tests:
    <<: *default_env
    steps:
      - *restore_repo
      - *resore_yarn_dependencies
      - run: sudo npm install -g yarn@1.3.2
      - run:
          name: Run test suite
          command: yarn test

  run_publish:
    <<: *default_env
    steps:
      - add_ssh_keys:
          fingerprints:
            - "c3:e1:06:83:f3:3e:7f:ef:93:10:3d:46:2d:17:06:1a"
      - *restore_repo
      - checkout
      - *resore_yarn_dependencies
      - run: yarn --production=false --cache-folder .yarncache
      - run: sudo npm install -g yarn@1.3.2
      - run:
          name: build storybook
          command: yarn lerna run build
      - run:
          name: lerna publish
          command: yarn lerna publish --conventional-commits --yes

workflows:
  version: 2
  build-and-test:
    jobs:
      - checkout_code:
          context: org-global
      - install_yarn_dependencies:
          requires:
            - checkout_code
      - run_tests:
          requires:
            - install_yarn_dependencies
      - run_publish:
          requires:
            - install_yarn_dependencies
          filters:
            branches:
              only: master
