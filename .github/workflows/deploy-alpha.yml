name: Deploy Storybook Preview

on:
  pull_request:
    branches-ignore:
      - main
      - gh-pages

env:
  NODE_VERSION: '22.13.1'
  NODE_OPTIONS: '--max_old_space_size=8196'
  NX_CLOUD: false
  IGNORE_COMMIT_MESSAGE: 'chore(release): publish'

permissions:
  id-token: write
  contents: read
  pull-requests: write
  issues: write

jobs:
  deploy-alpha:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Add NPM auth token file
        run: echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > .npmrc

      - name: Install dependencies
        run: yarn --production=false --frozen-lockfile

      - name: Ensure workflow is associated with a pull request
        run: |
          if [[ -z "${{ github.event.pull_request.number }}" ]]; then
            echo "This workflow is not associated with a pull request; exiting"
            exit 1
          fi

      - name: Skip build from automated commit
        id: check-commit
        run: |
          COMMIT_MESSAGE=$(git log --format=oneline -n 1 ${{ github.sha }})
          echo "Build started due to commit with message $COMMIT_MESSAGE, blocking builds started by ${IGNORE_COMMIT_MESSAGE}"
          if [[ $COMMIT_MESSAGE == *"${IGNORE_COMMIT_MESSAGE}"* ]]; then
            echo "Skipping build due to automated commit"
            exit 0
          fi

      - name: Set git user
        run: |
          git config --global user.email "dev@codecademy.com"
          git config --global user.name "codecademydev"
          git config --global push.default current

      - name: Build All Packages
        run: yarn build

      - name: Build Storybook
        run: yarn nx run styleguide:build-storybook

      - name: Check Netlify Status
        run: |
          # Set up Netlify CLI authentication
          export NETLIFY_AUTH_TOKEN="${{ secrets.NETLIFY_AUTH_TOKEN }}"
          export NETLIFY_SITE_ID="${{ secrets.NETLIFY_SITE_ID }}"

          echo "Checking Netlify authentication status..."
          echo "Site ID: $NETLIFY_SITE_ID"

          # Clean the token (remove any newlines or extra spaces)
          NETLIFY_AUTH_TOKEN=$(echo "$NETLIFY_AUTH_TOKEN" | tr -d '\n\r' | xargs)
          export NETLIFY_AUTH_TOKEN

          # Try to authenticate with Netlify CLI
          npx netlify-cli@22.1.3 status
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Deploy to Netlify
        id: deploy
        run: |
          DEPLOY_MESSAGE="User: ${{ github.actor }} Project: ${{ github.repository }} Pull Request: ${{ github.event.pull_request.html_url }}"

          # Set up Netlify CLI authentication
          export NETLIFY_AUTH_TOKEN="${{ secrets.NETLIFY_AUTH_TOKEN }}"
          export NETLIFY_SITE_ID="${{ secrets.NETLIFY_SITE_ID }}"

          # Try to list sites to see what's available
          # echo "Listing available sites..."
          # NETLIFY_AUTH_TOKEN="$NETLIFY_AUTH_TOKEN" npx netlify-cli@22.1.3 sites:list --filter @codecademy/styleguide --json || true

          # Link to the Netlify site with filter
          echo "Linking to Netlify site: $NETLIFY_SITE_ID"
          NETLIFY_AUTH_TOKEN="$NETLIFY_AUTH_TOKEN" npx netlify-cli@22.1.3 link --id $NETLIFY_SITE_ID --filter @codecademy/styleguide

          # Deploy to Netlify with filter
          echo "Deploying to Netlify..."
          NETLIFY_AUTH_TOKEN="$NETLIFY_AUTH_TOKEN" npx netlify-cli@22.1.3 deploy --message "${DEPLOY_MESSAGE}" --dir dist/storybook/styleguide --json --filter @codecademy/styleguide > .deploy-output
          echo "deploy-output=$(cat .deploy-output)" >> $GITHUB_OUTPUT
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Comment on PR with deployment info
        if: steps.deploy.outputs.deploy-output
        run: |
          export DEPLOY_OUTPUT="${{ steps.deploy.outputs.deploy-output }}"
          echo $DEPLOY_OUTPUT
          DEPLOY_URL=$(echo "console.log(JSON.parse(process.env.DEPLOY_OUTPUT).deploy_url)" | node -)
          LOGS_URL=$(echo "console.log(JSON.parse(process.env.DEPLOY_OUTPUT).logs)" | node -)
          COMMENT_MSG="<p><a href=\"${DEPLOY_URL}\">${DEPLOY_URL}</a></p><p><a href=\"${LOGS_URL}\">Deploy Logs</a></p>"
          if [ -z "$DEPLOY_OUTPUT" ]
          then
            echo "No deploy output found, will not add PR comment"
          else
            docker run --rm \
                    -e GITHUB_TOKEN \
                    -e GITHUB_OWNER="${{ github.repository_owner }}" \
                    -e GITHUB_REPO="${{ github.event.repository.name }}" \
                    -e GITHUB_COMMENT_TYPE=pr \
                    -e GITHUB_PR_ISSUE_NUMBER="${{ github.event.pull_request.number }}" \
                    -e GITHUB_COMMENT_TEMPLATE='<p>ðŸš€ Styleguide deploy preview ready!</p>{{.}}<!--ALPHA_DEPLOY_COMMENT-->' \
                    -e GITHUB_DELETE_COMMENT_REGEX="ALPHA_DEPLOY_COMMENT" \
                    -e GITHUB_COMMENT="${COMMENT_MSG}" \
                    cloudposse/github-commenter:0.5.0-58
          fi
