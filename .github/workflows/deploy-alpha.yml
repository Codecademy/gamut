name: Deploy Storybook Preview

on:
  pull_request:
    branches-ignore:
      - main
      - gh-pages

env:
  NODE_VERSION: '22.13.1'
  NODE_OPTIONS: '--max_old_space_size=8196'
  NX_CLOUD: false
  IGNORE_COMMIT_MESSAGE: 'chore(release): publish'

permissions:
  id-token: write
  contents: read
  pull-requests: write
  issues: write

jobs:
  deploy-alpha:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup and Build
        id: setup
        uses: ./.github/actions/yarn

      - name: Check if commit is automated
        id: check-commit
        run: |
          COMMIT_MESSAGE=$(git log --format=oneline -n 1 ${{ github.sha }})
          echo "Build started due to commit with message $COMMIT_MESSAGE, blocking builds started by ${IGNORE_COMMIT_MESSAGE}"
          if [[ $COMMIT_MESSAGE == *"${IGNORE_COMMIT_MESSAGE}"* ]]; then
            echo "is-automated=true" >> $GITHUB_OUTPUT
            echo "Skipping build due to automated commit"
          else
            echo "is-automated=false" >> $GITHUB_OUTPUT
          fi

      - name: Set git user
        if: steps.check-commit.outputs.is-automated == 'false'
        run: |
          git config --global user.email "dev@codecademy.com"
          git config --global user.name "codecademydev"
          git config --global push.default current

      - name: Build Storybook
        if: steps.check-commit.outputs.is-automated == 'false'
        run: yarn build && yarn nx run styleguide:build-storybook

      - name: Deploy to Netlify
        if: steps.check-commit.outputs.is-automated == 'false'
        id: deploy
        run: |
          DEPLOY_MESSAGE="User: ${{ github.actor }} Project: ${{ github.repository }} Pull Request: ${{ github.event.pull_request.html_url }}"
          echo "deploy-output=$(npx netlify-cli@22.1.3 deploy --message "${DEPLOY_MESSAGE}" --dir dist/storybook/styleguide --site ${{ secrets.NETLIFY_SITE_ID }} --json)" >> $GITHUB_OUTPUT
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Comment on PR with deployment info
        if: steps.check-commit.outputs.is-automated == 'false' && steps.deploy.outputs.deploy-output
        uses: marocchino/sticky-pull-request-comment@67d0dec7b07ed060a405f9b2a64b8ab319fdd7db
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          header: Storybook Deploy Preview
          recreate: true
          message: |
            ðŸš€ **Styleguide deploy preview ready!**

            **Deploy URL:** ${{ fromJson(steps.deploy.outputs.deploy-output).deploy_url }}
            **Deploy Logs:** ${{ fromJson(steps.deploy.outputs.deploy-output).logs }}

            <!--ALPHA_DEPLOY_COMMENT-->
