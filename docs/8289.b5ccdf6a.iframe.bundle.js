"use strict";(self.webpackChunkgamut_repo=self.webpackChunkgamut_repo||[]).push([[8289],{"./node_modules/@vidstack/react/prod/chunks/vidstack-7jdJQx_M.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{GoogleCastProvider:()=>GoogleCastProvider});var _vidstack_CNjv_Zem_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/@vidstack/react/prod/chunks/vidstack-CNjv_Zem.js"),_vidstack_WyKbSRm0_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/@vidstack/react/prod/chunks/vidstack-WyKbSRm0.js"),_vidstack_BEzgE0Fx_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./node_modules/@vidstack/react/prod/chunks/vidstack-BEzgE0Fx.js");__webpack_require__("./node_modules/react/index.js");class GoogleCastMediaInfoBuilder{#info;constructor(src){this.#info=new chrome.cast.media.MediaInfo(src.src,src.type)}build(){return this.#info}setStreamType(streamType){return streamType.includes("live")?this.#info.streamType=chrome.cast.media.StreamType.LIVE:this.#info.streamType=chrome.cast.media.StreamType.BUFFERED,this}setTracks(tracks){return this.#info.tracks=tracks.map(this.#buildCastTrack),this}setMetadata(title,poster){return this.#info.metadata=new chrome.cast.media.GenericMediaMetadata,this.#info.metadata.title=title,this.#info.metadata.images=[{url:poster}],this}#buildCastTrack(track,trackId){const castTrack=new chrome.cast.media.Track(trackId,chrome.cast.media.TrackType.TEXT);return castTrack.name=track.label,castTrack.trackContentId=track.src,castTrack.trackContentType="text/vtt",castTrack.language=track.language,castTrack.subtype=track.kind.toUpperCase(),castTrack}}class GoogleCastTracksManager{#cast;#ctx;#onNewLocalTracks;constructor(cast,ctx,onNewLocalTracks){this.#cast=cast,this.#ctx=ctx,this.#onNewLocalTracks=onNewLocalTracks}setup(){const syncRemoteActiveIds=this.syncRemoteActiveIds.bind(this);(0,_vidstack_CNjv_Zem_js__WEBPACK_IMPORTED_MODULE_1__.listenEvent)(this.#ctx.audioTracks,"change",syncRemoteActiveIds),(0,_vidstack_CNjv_Zem_js__WEBPACK_IMPORTED_MODULE_1__.listenEvent)(this.#ctx.textTracks,"mode-change",syncRemoteActiveIds),(0,_vidstack_CNjv_Zem_js__WEBPACK_IMPORTED_MODULE_1__.effect)(this.#syncLocalTracks.bind(this))}getLocalTextTracks(){return this.#ctx.$state.textTracks().filter((track=>track.src&&"vtt"===track.type))}#getLocalAudioTracks(){return this.#ctx.$state.audioTracks()}#getRemoteTracks(type){const tracks=this.#cast.mediaInfo?.tracks??[];return type?tracks.filter((track=>track.type===type)):tracks}#getRemoteActiveIds(){const activeIds=[],activeLocalAudioTrack=this.#getLocalAudioTracks().find((track=>track.selected)),activeLocalTextTracks=this.getLocalTextTracks().filter((track=>"showing"===track.mode));if(activeLocalAudioTrack){const remoteAudioTracks=this.#getRemoteTracks(chrome.cast.media.TrackType.AUDIO),remoteAudioTrack=this.#findRemoteTrack(remoteAudioTracks,activeLocalAudioTrack);remoteAudioTrack&&activeIds.push(remoteAudioTrack.trackId)}if(activeLocalTextTracks?.length){const remoteTextTracks=this.#getRemoteTracks(chrome.cast.media.TrackType.TEXT);if(remoteTextTracks.length)for(const localTrack of activeLocalTextTracks){const remoteTextTrack=this.#findRemoteTrack(remoteTextTracks,localTrack);remoteTextTrack&&activeIds.push(remoteTextTrack.trackId)}}return activeIds}#syncLocalTracks(){const localTextTracks=this.getLocalTextTracks();if(!this.#cast.isMediaLoaded)return;const remoteTextTracks=this.#getRemoteTracks(chrome.cast.media.TrackType.TEXT);for(const localTrack of localTextTracks){if(!this.#findRemoteTrack(remoteTextTracks,localTrack)){(0,_vidstack_CNjv_Zem_js__WEBPACK_IMPORTED_MODULE_1__.untrack)((()=>this.#onNewLocalTracks?.()));break}}}syncRemoteTracks(event){if(!this.#cast.isMediaLoaded)return;const localAudioTracks=this.#getLocalAudioTracks(),localTextTracks=this.getLocalTextTracks(),remoteAudioTracks=this.#getRemoteTracks(chrome.cast.media.TrackType.AUDIO),remoteTextTracks=this.#getRemoteTracks(chrome.cast.media.TrackType.TEXT);for(const remoteAudioTrack of remoteAudioTracks){if(this.#findLocalTrack(localAudioTracks,remoteAudioTrack))continue;const localAudioTrack={id:remoteAudioTrack.trackId.toString(),label:remoteAudioTrack.name,language:remoteAudioTrack.language,kind:remoteAudioTrack.subtype??"main",selected:!1};this.#ctx.audioTracks[_vidstack_WyKbSRm0_js__WEBPACK_IMPORTED_MODULE_2__.jH.add](localAudioTrack,event)}for(const remoteTextTrack of remoteTextTracks){if(this.#findLocalTrack(localTextTracks,remoteTextTrack))continue;const localTextTrack={id:remoteTextTrack.trackId.toString(),src:remoteTextTrack.trackContentId,label:remoteTextTrack.name,language:remoteTextTrack.language,kind:remoteTextTrack.subtype.toLowerCase()};this.#ctx.textTracks.add(localTextTrack,event)}}syncRemoteActiveIds(event){if(!this.#cast.isMediaLoaded)return;const activeIds=this.#getRemoteActiveIds(),editRequest=new chrome.cast.media.EditTracksInfoRequest(activeIds);this.#editTracksInfo(editRequest).catch((error=>{}))}#editTracksInfo(request){const media=(0,_vidstack_BEzgE0Fx_js__WEBPACK_IMPORTED_MODULE_3__.getCastSessionMedia)();return new Promise(((resolve,reject)=>media?.editTracksInfo(request,resolve,reject)))}#findLocalTrack(localTracks,remoteTrack){return localTracks.find((localTrack=>this.#isMatch(localTrack,remoteTrack)))}#findRemoteTrack(remoteTracks,localTrack){return remoteTracks.find((remoteTrack=>this.#isMatch(localTrack,remoteTrack)))}#isMatch(localTrack,remoteTrack){return remoteTrack.name===localTrack.label&&remoteTrack.language===localTrack.language&&remoteTrack.subtype.toLowerCase()===localTrack.kind.toLowerCase()}}class GoogleCastProvider{$$PROVIDER_TYPE="GOOGLE_CAST";scope=(0,_vidstack_CNjv_Zem_js__WEBPACK_IMPORTED_MODULE_1__.createScope)();#player;#ctx;#tracks;#currentSrc=null;#state="disconnected";#currentTime=0;#played=0;#seekableRange=new _vidstack_WyKbSRm0_js__WEBPACK_IMPORTED_MODULE_2__.zJ(0,0);#timeRAF=new _vidstack_WyKbSRm0_js__WEBPACK_IMPORTED_MODULE_2__.e8(this.#onAnimationFrame.bind(this));#playerEventHandlers;#reloadInfo=null;#isIdle=!1;constructor(player,ctx){this.#player=player,this.#ctx=ctx,this.#tracks=new GoogleCastTracksManager(player,ctx,this.#onNewLocalTracks.bind(this))}get type(){return"google-cast"}get currentSrc(){return this.#currentSrc}get player(){return this.#player}get cast(){return(0,_vidstack_BEzgE0Fx_js__WEBPACK_IMPORTED_MODULE_3__.getCastContext)()}get session(){return(0,_vidstack_BEzgE0Fx_js__WEBPACK_IMPORTED_MODULE_3__.getCastSession)()}get media(){return(0,_vidstack_BEzgE0Fx_js__WEBPACK_IMPORTED_MODULE_3__.getCastSessionMedia)()}get hasActiveSession(){return(0,_vidstack_BEzgE0Fx_js__WEBPACK_IMPORTED_MODULE_3__.hasActiveCastSession)(this.#currentSrc)}setup(){this.#attachCastContextEventListeners(),this.#attachCastPlayerEventListeners(),this.#tracks.setup(),this.#ctx.notify("provider-setup",this)}#attachCastContextEventListeners(){(0,_vidstack_BEzgE0Fx_js__WEBPACK_IMPORTED_MODULE_3__.listenCastContextEvent)(cast.framework.CastContextEventType.CAST_STATE_CHANGED,this.#onCastStateChange.bind(this))}#attachCastPlayerEventListeners(){const Event2=cast.framework.RemotePlayerEventType,handlers={[Event2.IS_CONNECTED_CHANGED]:this.#onCastStateChange,[Event2.IS_MEDIA_LOADED_CHANGED]:this.#onMediaLoadedChange,[Event2.CAN_CONTROL_VOLUME_CHANGED]:this.#onCanControlVolumeChange,[Event2.CAN_SEEK_CHANGED]:this.#onCanSeekChange,[Event2.DURATION_CHANGED]:this.#onDurationChange,[Event2.IS_MUTED_CHANGED]:this.#onVolumeChange,[Event2.VOLUME_LEVEL_CHANGED]:this.#onVolumeChange,[Event2.IS_PAUSED_CHANGED]:this.#onPausedChange,[Event2.LIVE_SEEKABLE_RANGE_CHANGED]:this.#onProgress,[Event2.PLAYER_STATE_CHANGED]:this.#onPlayerStateChange};this.#playerEventHandlers=handlers;const handler=this.#onRemotePlayerEvent.bind(this);for(const type of(0,_vidstack_CNjv_Zem_js__WEBPACK_IMPORTED_MODULE_1__.keysOf)(handlers))this.#player.controller.addEventListener(type,handler);(0,_vidstack_CNjv_Zem_js__WEBPACK_IMPORTED_MODULE_1__.onDispose)((()=>{for(const type of(0,_vidstack_CNjv_Zem_js__WEBPACK_IMPORTED_MODULE_1__.keysOf)(handlers))this.#player.controller.removeEventListener(type,handler)}))}async play(){(this.#player.isPaused||this.#isIdle)&&(this.#isIdle?await this.#reload(!1,0):this.#player.controller?.playOrPause())}async pause(){this.#player.isPaused||this.#player.controller?.playOrPause()}getMediaStatus(request){return new Promise(((resolve,reject)=>{this.media?.getStatus(request,resolve,reject)}))}setMuted(muted){(muted&&!this.#player.isMuted||!muted&&this.#player.isMuted)&&this.#player.controller?.muteOrUnmute()}setCurrentTime(time){this.#player.currentTime=time,this.#ctx.notify("seeking",time),this.#player.controller?.seek()}setVolume(volume){this.#player.volumeLevel=volume,this.#player.controller?.setVolumeLevel()}async loadSource(src){if(this.#reloadInfo?.src!==src&&(this.#reloadInfo=null),(0,_vidstack_BEzgE0Fx_js__WEBPACK_IMPORTED_MODULE_3__.hasActiveCastSession)(src))return this.#resumeSession(),void(this.#currentSrc=src);this.#ctx.notify("load-start");const loadRequest=this.#buildLoadRequest(src),errorCode=await this.session.loadMedia(loadRequest);if(errorCode)return this.#currentSrc=null,void this.#ctx.notify("error",Error((0,_vidstack_BEzgE0Fx_js__WEBPACK_IMPORTED_MODULE_3__.getCastErrorMessage)(errorCode)));this.#currentSrc=src}destroy(){this.#reset(),this.#endSession()}#reset(){this.#reloadInfo||(this.#played=0,this.#seekableRange=new _vidstack_WyKbSRm0_js__WEBPACK_IMPORTED_MODULE_2__.zJ(0,0)),this.#timeRAF.stop(),this.#currentTime=0,this.#reloadInfo=null}#resumeSession(){const resumeSessionEvent=new _vidstack_CNjv_Zem_js__WEBPACK_IMPORTED_MODULE_1__.DOMEvent("resume-session",{detail:this.session});this.#onMediaLoadedChange(resumeSessionEvent);const{muted,volume,savedState}=this.#ctx.$state,localState=savedState();this.setCurrentTime(Math.max(this.#player.currentTime,localState?.currentTime??0)),this.setMuted(muted()),this.setVolume(volume()),!1===localState?.paused&&this.play()}#endSession(){this.cast.endCurrentSession(!0);const{remotePlaybackLoader}=this.#ctx.$state;remotePlaybackLoader.set(null)}#disconnectFromReceiver(){const{savedState}=this.#ctx.$state;savedState.set({paused:this.#player.isPaused,currentTime:this.#player.currentTime}),this.#endSession()}#onAnimationFrame(){this.#onCurrentTimeChange()}#onRemotePlayerEvent(event){this.#playerEventHandlers[event.type].call(this,event)}#onCastStateChange(data){const castState=this.cast.getCastState(),state=castState===cast.framework.CastState.CONNECTED?"connected":castState===cast.framework.CastState.CONNECTING?"connecting":"disconnected";if(this.#state===state)return;const detail={type:"google-cast",state},trigger=this.#createEvent(data);this.#state=state,this.#ctx.notify("remote-playback-change",detail,trigger),"disconnected"===state&&this.#disconnectFromReceiver()}#onMediaLoadedChange(event){if(!!!this.#player.isMediaLoaded)return;const src=(0,_vidstack_CNjv_Zem_js__WEBPACK_IMPORTED_MODULE_1__.peek)(this.#ctx.$state.source);Promise.resolve().then((()=>{if(src!==(0,_vidstack_CNjv_Zem_js__WEBPACK_IMPORTED_MODULE_1__.peek)(this.#ctx.$state.source)||!this.#player.isMediaLoaded)return;this.#reset();const duration=this.#player.duration;this.#seekableRange=new _vidstack_WyKbSRm0_js__WEBPACK_IMPORTED_MODULE_2__.zJ(0,duration);const detail={provider:this,duration,buffered:new _vidstack_WyKbSRm0_js__WEBPACK_IMPORTED_MODULE_2__.zJ(0,0),seekable:this.#getSeekableRange()},trigger=this.#createEvent(event);this.#ctx.notify("loaded-metadata",void 0,trigger),this.#ctx.notify("loaded-data",void 0,trigger),this.#ctx.notify("can-play",detail,trigger),this.#onCanControlVolumeChange(),this.#onCanSeekChange(event);const{volume,muted}=this.#ctx.$state;this.setVolume(volume()),this.setMuted(muted()),this.#timeRAF.start(),this.#tracks.syncRemoteTracks(trigger),this.#tracks.syncRemoteActiveIds(trigger)}))}#onCanControlVolumeChange(){this.#ctx.$state.canSetVolume.set(this.#player.canControlVolume)}#onCanSeekChange(event){const trigger=this.#createEvent(event);this.#ctx.notify("stream-type-change",this.#getStreamType(),trigger)}#getStreamType(){const streamType=this.#player.mediaInfo?.streamType;return streamType===chrome.cast.media.StreamType.LIVE?this.#player.canSeek?"live:dvr":"live":"on-demand"}#onCurrentTimeChange(){if(this.#reloadInfo)return;const currentTime=this.#player.currentTime;currentTime!==this.#currentTime&&(this.#ctx.notify("time-change",currentTime),currentTime>this.#played&&(this.#played=currentTime,this.#onProgress()),this.#ctx.$state.seeking()&&this.#ctx.notify("seeked",currentTime),this.#currentTime=currentTime)}#onDurationChange(event){if(!this.#player.isMediaLoaded||this.#reloadInfo)return;const duration=this.#player.duration,trigger=this.#createEvent(event);this.#seekableRange=new _vidstack_WyKbSRm0_js__WEBPACK_IMPORTED_MODULE_2__.zJ(0,duration),this.#ctx.notify("duration-change",duration,trigger)}#onVolumeChange(event){if(!this.#player.isMediaLoaded)return;const detail={muted:this.#player.isMuted,volume:this.#player.volumeLevel},trigger=this.#createEvent(event);this.#ctx.notify("volume-change",detail,trigger)}#onPausedChange(event){const trigger=this.#createEvent(event);this.#player.isPaused?this.#ctx.notify("pause",void 0,trigger):this.#ctx.notify("play",void 0,trigger)}#onProgress(event){const detail={seekable:this.#getSeekableRange(),buffered:new _vidstack_WyKbSRm0_js__WEBPACK_IMPORTED_MODULE_2__.zJ(0,this.#played)},trigger=event?this.#createEvent(event):void 0;this.#ctx.notify("progress",detail,trigger)}#onPlayerStateChange(event){const state=this.#player.playerState,PlayerState=chrome.cast.media.PlayerState;if(this.#isIdle=state===PlayerState.IDLE,state===PlayerState.PAUSED)return;const trigger=this.#createEvent(event);switch(state){case PlayerState.PLAYING:this.#ctx.notify("playing",void 0,trigger);break;case PlayerState.BUFFERING:this.#ctx.notify("waiting",void 0,trigger);break;case PlayerState.IDLE:this.#timeRAF.stop(),this.#ctx.notify("pause"),this.#ctx.notify("end")}}#getSeekableRange(){return this.#player.liveSeekableRange?new _vidstack_WyKbSRm0_js__WEBPACK_IMPORTED_MODULE_2__.zJ(this.#player.liveSeekableRange.start,this.#player.liveSeekableRange.end):this.#seekableRange}#createEvent(detail){return detail instanceof Event?detail:new _vidstack_CNjv_Zem_js__WEBPACK_IMPORTED_MODULE_1__.DOMEvent(detail.type,{detail})}#buildMediaInfo(src){const{streamType,title,poster}=this.#ctx.$state;return new GoogleCastMediaInfoBuilder(src).setMetadata(title(),poster()).setStreamType(streamType()).setTracks(this.#tracks.getLocalTextTracks()).build()}#buildLoadRequest(src){const mediaInfo=this.#buildMediaInfo(src),request=new chrome.cast.media.LoadRequest(mediaInfo),savedState=this.#ctx.$state.savedState();return request.autoplay=!1===(this.#reloadInfo?.paused??savedState?.paused),request.currentTime=this.#reloadInfo?.time??savedState?.currentTime??0,request}async#reload(paused,time){const src=(0,_vidstack_CNjv_Zem_js__WEBPACK_IMPORTED_MODULE_1__.peek)(this.#ctx.$state.source);this.#reloadInfo={src,paused,time},await this.loadSource(src)}#onNewLocalTracks(){this.#reload(this.#player.isPaused,this.#player.currentTime).catch((error=>{}))}}}}]);